---

- name: Install PHP
  apt:
    name: "{{ item }}"
    state: present
    # update_cache: yes
  with_items:
    - php5-cli
    - php5-curl
    - php5-fpm
    - php5-intl
    - php5-json
    - php5-mcrypt
    - php5-dev
    - php5-gd
    - php5-mbstring
    - php5-mcrypt
    - php5-mysql
    - php5-opcache
    - php5-xml
    - php5-xmlrpc
    - php5-zip




- name: Set PHP user
  lineinfile: 
    dest: /etc/php5/fpm/pool.d/www.conf
    regexp: "^user"
    line: "user = {{ webserver_user }}"
    state: present
  when: webserver_user
  notify: restart php
  ignore_errors: yes

- name: Set PHP group    
  lineinfile: 
    dest: /etc/php5/fpm/pool.d/www.conf
    regexp: "^group"
    line: "group = {{ webserver_group }}"
    state: present
  when: webserver_group
  notify: restart php
  ignore_errors: yes

- name: Use Socket instead of port
  lineinfile: 
    dest: /etc/php5/fpm/pool.d/www.conf
    regexp: "^listen"
    line: "listen = /var/run/php-fpm.sock"
    state: present
  notify: restart php
  ignore_errors: yes
  
- name: Set PHP listen owner    
  lineinfile: 
    dest: /etc/php5/fpm/pool.d/www.conf
    regexp: "^listen\\.owner"
    line: "listen.owner = {{ webserver_user }}"
    state: present
  when: webserver_user
  notify: restart php
  ignore_errors: yes

- name: Set PHP listen group    
  lineinfile: 
    dest: /etc/php5/fpm/pool.d/www.conf
    regexp: "^listen\\.group"
    line: "listen.group = {{ webserver_group }}"
    state: present
  when: webserver_group
  notify: restart php
  ignore_errors: yes

- name: Set PHP upload max filesize    
  lineinfile: 
    dest: /etc/php5/fpm/php.ini
    regexp: "^upload_max_filesize"
    line: "upload_max_filesize = 128M"
    state: present
  notify: reload php
  ignore_errors: yes

- name: Set PHP post max filesize    
  lineinfile: 
    dest: /etc/php5/fpm/php.ini
    regexp: "^post_max_size"
    line: "post_max_size = 128M"
    state: present
  notify: reload php
  ignore_errors: yes

- name: Ensure FPM cgi.fix_pathinfo=0
  lineinfile:
    dest: /etc/php5/fpm/php.ini
    regexp: '^(.*)cgi.fix_pathinfo='
    line: cgi.fix_pathinfo=0
    state: present
  notify: reload php
  ignore_errors: yes

- name: Copy index.php
  copy:
    src: index.php
    dest: /var/www/html/index.php
